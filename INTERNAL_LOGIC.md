# 模块化智能体 CLI 运行机制

## 核心启动逻辑

1. **入口函数**: 脚本的执行从 `main()` 函数开始。首先打印欢迎信息和提示，示例如："把当前文件夹下的图片合并为 PDF"，提示用户输入。

2. **API 密钥检查**: 脚本检查环境变量是否设置了 `OPENAI_API_KEY`，若未设置则输出警告信息并退出。

3. **图的初始化**: 调用 `build_graph()` 函数初始化应用的图结构。

4. **交互会话初始化**: 使用 `PromptSession` 初始化一个用户交互会话，以支持历史记录和更高级的输入体验。


## 消息处理流程

1. **用户输入**: 进入一个 `while True` 循环，程序等待用户输入。
    - 用户可以输入指令，如果输入是 "exit" 或 "quit"，程序将退出。
    - 如果用户输入空白，则将其忽略。

2. **构建输入信息**: 构建包含用户历史消息和当前用户输入的字典 `inputs`，同时保持当前活跃技能的状态。

3. **流式处理**: 将 `inputs` 传递给应用的 `stream` 方法，并进入流模式（`stream_mode="values"`）。
    - 在处理每个事件时，获取最后一条消息，并更新活跃技能的信息。

4. **消息类型判断**: 根据最后一条消息的类型进行不同的处理:  
    - 如果最后一条是 `AIMessage`:
        - **工具调用**: 输出思考过程和工具调用的信息。
        - **最终回答**: 输出智能体的最终回答。

5. **更新历史记录**: 将当前事件的消息更新到 `chat_history`，为下一轮交互做准备。

6. **异常处理**: 使用 `try-except` 结构来捕获键盘中断和其他异常，确保程序在遇到错误时仍能优雅地关闭。

通过这种机制，模块化智能体 CLI 能够与用户进行有效的互动，处理各种命令并调用相应的技能。